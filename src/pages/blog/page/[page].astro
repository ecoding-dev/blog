---
import { getCollection } from 'astro:content';
import BaseHead from '../../../components/BaseHead.astro';
import Header from '../../../components/sections/Header.astro';
import Footer from '../../../components/sections/Footer.astro';
import BlogHero from '../../../components/sections/BlogHero.astro';
import BlogAllArticles from '../../../components/sections/BlogAllArticles.astro';
import BlogPagination from '../../../components/ui/nav/BlogPagination.astro';

export async function getStaticPaths() {
  const PAGE_SIZE = 6;
  const posts = (await getCollection('blog')).sort((a, b) => +b.data.pubDate - +a.data.pubDate);
  const totalPages = Math.max(1, Math.ceil(posts.length / PAGE_SIZE));
  return Array.from({ length: totalPages - 1 }, (_, i) => ({ params: { page: String(i + 2) } }));
}

const PAGE_SIZE = 6;
const posts = (await getCollection('blog')).sort((a, b) => +b.data.pubDate - +a.data.pubDate);
const { page } = Astro.params;
const currentPage = Math.max(1, parseInt(page || '1', 10));
const start = (currentPage - 1) * PAGE_SIZE;
const end = start + PAGE_SIZE;
const pagePosts = posts.slice(start, end);
const totalPages = Math.max(1, Math.ceil(posts.length / PAGE_SIZE));
const basePath = '/blog/page';
---

<html lang="en" data-theme="dark" class="dark">
  <head>
    <BaseHead title={`Blog - Page ${currentPage}`} description={`Blog page ${currentPage}`} />
    {currentPage > 1 && (
      <link rel="prev" href={currentPage === 2 ? `/blog/` : `${basePath}/${currentPage - 1}/`} />
    )}
    {currentPage < totalPages && (
      <link rel="next" href={`${basePath}/${currentPage + 1}/`} />
    )}
  </head>
  <body>
    <Header />
    <BlogHero title="Blog" subtitle="Ideas prácticas sobre análisis de datos, visualización y cómo sacar más provecho a tus herramientas de analítica." />
    <main class="use-utility-layout mx-auto max-w-5xl px-3 py-5 space-y-7">
      <BlogAllArticles posts={pagePosts} />
      <BlogPagination
          currentPage={currentPage}
          totalPages={totalPages}
          basePath={`/blog/page`}
          firstPagePath={`/blog/`}
      />
    </main>
    <Footer />
  </body>
</html>
