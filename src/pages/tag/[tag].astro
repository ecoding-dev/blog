---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/sections/Header.astro';
import Footer from '../../components/sections/Footer.astro';
import PostCard from '../../components/ui/card/PostCard.astro';
import BlogPagination from '../../components/ui/nav/BlogPagination.astro';

import { slugifyTag } from '../../lib/slug';
import { getTagMeta } from '../../data/tags';
import BaseBody from "../../components/BaseBody.astro";

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tags = [...new Set(
      posts.flatMap((p) => p.data.tags || [])
          .filter((t) => typeof t === 'string' && t.trim() !== '')
  )].map(slugifyTag);

  // Sólo tags que efectivamente tienen posts
  const tagsWithPosts = tags.filter((sTag) =>
      posts.some((p) => (p.data.tags || []).some((t) => slugifyTag(t) === sTag))
  );

  return tagsWithPosts.map((sTag) => ({ params: { tag: sTag } }));
}

const PAGE_SIZE = 6;
const { tag } = Astro.params;

const all = await getCollection('blog');
const posts = all
    .filter((p) => (p.data.tags || []).some((t) => slugifyTag(t) === tag))
    .sort((a, b) => +b.data.pubDate - +a.data.pubDate);

const totalPages = Math.max(1, Math.ceil(posts.length / PAGE_SIZE));
const currentPage = 1;
const start = (currentPage - 1) * PAGE_SIZE;
const pagePosts = posts.slice(start, start + PAGE_SIZE);

const meta = getTagMeta(tag);
const title = `Etiqueta: ${meta.title}`;
const description = `Artículos etiquetados como ${meta.title}.`;
---

<html lang="es" data-theme="dark" class="dark">
<head>
  <BaseHead title={title} description={description} />
  {totalPages > 1 && <link rel="next" href={`/tag/${tag}/page/2/`} />}
</head>
<body>
<BaseBody/>
<Header />
<main class="mx-auto max-w-6xl px-4 py-10 space-y-6">
  <h1 class="text-3xl font-bold">{title}</h1>
  <div class="blog-grid">
    {pagePosts.map((p) => <PostCard post={p} />)}
  </div>
  <BlogPagination
      currentPage={currentPage}
      totalPages={totalPages}
      basePath={`/tag/${tag}/page`}
      firstPagePath={`/tag/${tag}`}
  />
</main>
<Footer />
</body>
</html>
